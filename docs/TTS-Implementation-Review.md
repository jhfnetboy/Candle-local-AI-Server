# TTS å®ç°è¯„ä¼°ä¸æœ€ä½³å®è·µå¯¹æ¯”

**æ—¥æœŸ**: 2025-11-30
**ç‰ˆæœ¬**: 0.1.0
**å‚è€ƒ**: Kokoros å®˜æ–¹å®ç°

---

## 1. å½“å‰å®ç°åˆ†æ

### 1.1 ç®€åŒ–éŸ³ç´ åŒ– (simple_phonemize)

```rust
fn simple_phonemize(&self, text: &str) -> String {
    // ç®€åŒ–ç‰ˆ: åªä¿ç•™ ASCII å­—æ¯å’Œç©ºæ ¼
    text.chars()
        .filter(|c| c.is_ascii_alphanumeric() || c.is_whitespace())
        .collect::<String>()
        .to_lowercase()
}
```

**é—®é¢˜**:
- âŒ **ä¸æ˜¯çœŸæ­£çš„éŸ³ç´ åŒ–** - åªæ˜¯ç®€å•çš„å­—ç¬¦è¿‡æ»¤
- âŒ **æ— æ³•å¤„ç†å‘éŸ³è§„åˆ™** - "hello" è¾“å‡ºè¿˜æ˜¯ "hello"ï¼Œè€Œé IPA éŸ³ç´  "hÉ™ËˆloÊŠ"
- âŒ **è‹±æ–‡å•è¯ç›´æ¥ä½œä¸º token** - è¯æ±‡è¡¨æœŸæœ›çš„æ˜¯ IPA ç¬¦å·,ä¸æ˜¯å­—æ¯

**å½±å“**:
- Token è´¨é‡å·® - æ¨¡å‹æ— æ³•æ­£ç¡®ç†è§£è¾“å…¥
- ç”ŸæˆéŸ³é¢‘è´¨é‡ä½ - å¯èƒ½æ˜¯å™ªéŸ³æˆ–ä¸è‡ªç„¶çš„å£°éŸ³
- ä¸è®­ç»ƒæ•°æ®ä¸åŒ¹é… - Kokoro-82M è®­ç»ƒæ—¶ä½¿ç”¨çš„æ˜¯çœŸå® IPA éŸ³ç´ 

---

### 1.2 éŸ³é¢‘ç”Ÿæˆæ—¶é•¿é—®é¢˜

**æµ‹è¯•ç»“æœ**:
```
è¾“å…¥: "Hello beautiful world" (3ä¸ªå•è¯)
éŸ³é¢‘: 316,200 æ ·æœ¬ = 13.2ç§’ @ 24kHz
```

**åˆ†æ**:
1. **æ¨ç†æ—¶é—´**: çº¦ 7 ç§’ (ONNX æ‰§è¡Œ)
2. **éŸ³é¢‘æ—¶é•¿**: 13.2 ç§’ (ç”Ÿæˆçš„éŸ³é¢‘å®é™…é•¿åº¦)

**é—®é¢˜**:
- âœ… æ¨ç†æ—¶é—´ 7 ç§’æ˜¯æ­£å¸¸çš„ (CPU æ¨ç†,æ— åŠ é€Ÿ)
- âš ï¸ éŸ³é¢‘æ—¶é•¿ 13.2 ç§’ **è¿‡é•¿**
  - æ­£å¸¸è¯­é€Ÿ: 3ä¸ªå•è¯åº”è¯¥çº¦ 1-2 ç§’
  - å½“å‰: æ¯ä¸ªå•è¯ 4.4 ç§’ (ææ…¢)

**åŸå› **:
```
é”™è¯¯çš„è¾“å…¥ â†’ æ¨¡å‹å›°æƒ‘ â†’ ç”Ÿæˆå¤§é‡å¡«å……éŸ³/åœé¡¿
```

ç”±äºæˆ‘ä»¬è¾“å…¥çš„æ˜¯å­—æ¯ "h e l l o" è€ŒééŸ³ç´  "h É™ Ëˆ l oÊŠ",æ¨¡å‹æ— æ³•æ­£ç¡®è§£æ,å¯¼è‡´:
- å¤§é‡é™éŸ³/å¡«å……
- é”™è¯¯çš„éŸ³ç´ æŒç»­æ—¶é—´
- ä¸è‡ªç„¶çš„è¯­è°ƒ

---

## 2. Kokoros æœ€ä½³å®è·µ

### 2.1 å®Œæ•´çš„æ–‡æœ¬å¤„ç†æµç¨‹

æ ¹æ® Kokoros å®˜æ–¹å®ç° (`kokoros/src/tts/`):

```
æ–‡æœ¬ (Text)
   â†“
1. æ–‡æœ¬è§„èŒƒåŒ– (normalize.rs)
   â†“ "Hello!" â†’ "hello"
2. éŸ³ç´ åŒ– (phonemizer.rs + espeak)
   â†“ "hello" â†’ "hÉ™ËˆloÊŠ"
3. TokenåŒ– (tokenize.rs)
   â†“ "hÉ™ËˆloÊŠ" â†’ [50, 83, 135, 3, 16, 65]
4. ONNX æ¨ç†
   â†“
   éŸ³é¢‘æ³¢å½¢
```

---

### 2.2 å…³é”®ç»„ä»¶å¯¹æ¯”

| ç»„ä»¶ | æˆ‘ä»¬çš„å®ç° | Kokoros æœ€ä½³å®è·µ | å·®è· |
|------|-----------|-----------------|------|
| **æ–‡æœ¬è§„èŒƒåŒ–** | âŒ æ—  | âœ… `normalize::normalize_text()` | ğŸ”´ ä¸¥é‡ |
| **éŸ³ç´ åŒ–å¼•æ“** | âŒ å­—ç¬¦è¿‡æ»¤ | âœ… espeak-ng (IPA) | ğŸ”´ ä¸¥é‡ |
| **è¯æ±‡è¡¨** | âœ… æ­£ç¡® (171 å­—ç¬¦) | âœ… ç›¸åŒ | âœ… åŒ¹é… |
| **TokenåŒ–** | âœ… æ­£ç¡® | âœ… ç›¸åŒ | âœ… åŒ¹é… |
| **Style Vectors** | âœ… æ­£ç¡®åŠ è½½ | âœ… ç›¸åŒ | âœ… åŒ¹é… |
| **ONNX æ¨ç†** | âœ… æ­£ç¡® | âœ… ç›¸åŒ | âœ… åŒ¹é… |

**æ€»ç»“**: æ ¸å¿ƒé—®é¢˜åœ¨ **éŸ³ç´ åŒ–** ç¯èŠ‚

---

### 2.3 çœŸå®éŸ³ç´ åŒ–ç¤ºä¾‹

#### espeak-ng è¾“å‡º:

```bash
# å®‰è£…
brew install espeak-ng

# æµ‹è¯•
espeak-ng -v en-us -q --ipa "Hello beautiful world"

# è¾“å‡º (IPA)
hÉ™lËˆoÊŠ bjËˆuËtÉªfÉ™l wËˆÉœËld
```

#### Token æ˜ å°„:

```
éŸ³ç´ : "hÉ™lËˆoÊŠ bjËˆuËtÉªfÉ™l wËˆÉœËld"
     â†“ (è¯æ±‡è¡¨æŸ¥æ‰¾)
Token IDs: [50, 83, 16, 135, 3, 16, 65, 4, 17, ...]
```

---

## 3. æ€§èƒ½å¯¹æ¯”

### 3.1 Kokoros å®˜æ–¹æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | æ•°å€¼ | è¯´æ˜ |
|------|------|------|
| **æ¨ç†é€Ÿåº¦** | ~0.5-1ç§’ / 10å•è¯ | CPU (M1/M2) |
| **éŸ³é¢‘è´¨é‡** | é«˜è‡ªç„¶åº¦ | æ­£ç¡®éŸ³ç´ è¾“å…¥ |
| **å®æ—¶ç‡** | 10-20x | æ¯”å®æ—¶å¿« 10-20 å€ |
| **å†…å­˜å ç”¨** | ~500MB | æ¨¡å‹+è¿è¡Œæ—¶ |

### 3.2 æˆ‘ä»¬çš„å®ç°æ€§èƒ½

| æŒ‡æ ‡ | æ•°å€¼ | è¯´æ˜ |
|------|------|------|
| **æ¨ç†é€Ÿåº¦** | ~7ç§’ / 3å•è¯ | CPU (æ— ä¼˜åŒ–) |
| **éŸ³é¢‘è´¨é‡** | âš ï¸ ä½ | é”™è¯¯éŸ³ç´ è¾“å…¥ |
| **å®æ—¶ç‡** | ~2x | å‹‰å¼ºå®æ—¶ |
| **å†…å­˜å ç”¨** | ~400MB | æ­£å¸¸ |

**ç“¶é¢ˆ**:
1. âŒ éŸ³ç´ åŒ–ç¼ºå¤± â†’ éŸ³é¢‘è´¨é‡å·®
2. âš ï¸ æ¨ç†é€Ÿåº¦æ…¢ â†’ å¯ä¼˜åŒ–

---

## 4. æ”¹è¿›è·¯çº¿å›¾

### 4.1 çŸ­æœŸ (1-2 å¤©) - ä¿®å¤æ ¸å¿ƒé—®é¢˜

#### ä¼˜å…ˆçº§ 1: é›†æˆ espeak-ng

**æ–¹æ¡ˆ A: è°ƒç”¨ç³»ç»Ÿ espeak** (æ¨è - å¿«é€Ÿ)
```rust
use std::process::Command;

fn phonemize_espeak(text: &str) -> Result<String> {
    let output = Command::new("espeak-ng")
        .args(&["-v", "en-us", "-q", "--ipa", text])
        .output()?;

    Ok(String::from_utf8(output.stdout)?.trim().to_string())
}
```

**ä¼˜ç‚¹**:
- âœ… ç«‹å³å¯ç”¨ (1 å°æ—¶å®ç°)
- âœ… å®Œæ•´ espeak åŠŸèƒ½
- âœ… æ”¯æŒå¤šè¯­è¨€

**ç¼ºç‚¹**:
- âš ï¸ éœ€è¦ç³»ç»Ÿå®‰è£… espeak-ng
- âš ï¸ è¿›ç¨‹è°ƒç”¨å¼€é”€ (~10ms)

---

**æ–¹æ¡ˆ B: Rust espeak ç»‘å®š** (å®Œç¾ - ä½†å¤æ‚)
```toml
[dependencies]
espeak-ng-sys = "0.1"  # FFI ç»‘å®š
```

**ä¼˜ç‚¹**:
- âœ… é›¶å¤–éƒ¨ä¾èµ–
- âœ… æ€§èƒ½æœ€ä½³ (æ— è¿›ç¨‹è°ƒç”¨)
- âœ… å®Œå…¨æ§åˆ¶

**ç¼ºç‚¹**:
- âš ï¸ éœ€è¦ç¼–è¯‘ espeak-ng C åº“
- âš ï¸ è·¨å¹³å°å¤æ‚åº¦é«˜
- âš ï¸ å¼€å‘æ—¶é—´é•¿ (1-2 å¤©)

---

#### ä¼˜å…ˆçº§ 2: æ–‡æœ¬è§„èŒƒåŒ–

å‚è€ƒ `kokoros/src/tts/normalize.rs`:

```rust
fn normalize_text(text: &str) -> String {
    text
        // è½¬å°å†™
        .to_lowercase()
        // ç§»é™¤å¤šä½™ç©ºæ ¼
        .split_whitespace()
        .collect::<Vec<_>>()
        .join(" ")
        // å¤„ç†æ ‡ç‚¹ç¬¦å·
        .replace("...", "â€¦")
        // æ•°å­—è½¬æ–‡å­—
        .replace("1", "one")
        .replace("2", "two")
        // ...
}
```

---

### 4.2 ä¸­æœŸ (3-5 å¤©) - æ€§èƒ½ä¼˜åŒ–

#### 1. ONNX Runtime ä¼˜åŒ–

```rust
// å½“å‰
Session::builder()?
    .with_optimization_level(GraphOptimizationLevel::Level3)?
    .with_intra_threads(4)?

// ä¼˜åŒ–
Session::builder()?
    .with_optimization_level(GraphOptimizationLevel::Level3)?
    .with_intra_threads(8)?  // å¢åŠ çº¿ç¨‹
    .with_execution_mode(ExecutionMode::Parallel)?  // å¹¶è¡Œæ‰§è¡Œ
```

**é¢„æœŸ**: æ¨ç†é€Ÿåº¦æå‡ 30-50%

---

#### 2. æ‰¹å¤„ç†æ¨ç†

```rust
// å½“å‰: å•æ¡è¯·æ±‚
synthesize("Hello world")

// ä¼˜åŒ–: æ‰¹é‡è¯·æ±‚
synthesize_batch(vec![
    "Hello world",
    "Good morning",
    "How are you"
])
```

**é¢„æœŸ**: ååé‡æå‡ 3-5x

---

#### 3. æ¨¡å‹é‡åŒ–

```bash
# ä½¿ç”¨ ONNX quantized æ¨¡å‹
curl -L https://huggingface.co/onnx-community/Kokoro-82M-v1.0-ONNX/resolve/main/onnx/model_quantized.onnx \
  -o checkpoints/kokoro-v1.0-q8.onnx
```

| æ¨¡å‹ | å¤§å° | é€Ÿåº¦ | è´¨é‡ |
|------|------|------|------|
| fp32 | 310MB | åŸºå‡† | æœ€ä½³ |
| q8 | 82MB | 2-3x å¿« | æ¥è¿‘ |
| q4 | 41MB | 4-5x å¿« | è‰¯å¥½ |

---

### 4.3 é•¿æœŸ (1-2 å‘¨) - åŠŸèƒ½å®Œå–„

1. **å¤šè¯­è¨€æ”¯æŒ**
   - en-us, en-gb, zh-cn
   - æ¯ç§è¯­è¨€ç‹¬ç«‹ espeak é…ç½®

2. **è¯­éŸ³é£æ ¼æ§åˆ¶**
   - åŠ è½½å¤šä¸ª voice.bin
   - ç”¨æˆ·é€‰æ‹©è¯´è¯äºº

3. **é«˜çº§å‚æ•°**
   - è¯­é€Ÿæ§åˆ¶ (speed: 0.5 - 2.0)
   - éŸ³é«˜è°ƒæ•´
   - æƒ…æ„Ÿæ§åˆ¶

4. **æµå¼åˆæˆ**
   - è¾¹ç”Ÿæˆè¾¹æ’­æ”¾
   - é™ä½å»¶è¿Ÿ

---

## 5. ç«‹å³è¡ŒåŠ¨è®¡åˆ’

### ğŸ”¥ ä»Šå¤©å®Œæˆ (2-4 å°æ—¶)

#### Step 1: å®‰è£… espeak-ng
```bash
brew install espeak-ng

# æµ‹è¯•
espeak-ng -v en-us -q --ipa "Hello world"
# è¾“å‡º: hÉ™lËˆoÊŠ wËˆÉœËld
```

#### Step 2: æ›¿æ¢ simple_phonemize
```rust
fn phonemize_with_espeak(&self, text: &str) -> Result<String> {
    let output = Command::new("espeak-ng")
        .args(&["-v", "en-us", "-q", "--ipa", text])
        .output()
        .context("espeak-ng æœªå®‰è£…")?;

    let phonemes = String::from_utf8(output.stdout)?
        .trim()
        .to_string();

    // Kokoro-specific æ›¿æ¢
    let phonemes = phonemes
        .replace("kÉ™kËˆoËÉ¹oÊŠ", "kËˆoÊŠkÉ™É¹oÊŠ")
        .replace("Ê²", "j")
        .replace("r", "É¹")
        .replace("x", "k");

    Ok(phonemes)
}
```

#### Step 3: æµ‹è¯•
```bash
curl -X POST http://localhost:9527/synthesize \
  -H "Content-Type: application/json" \
  -d '{"text": "Hello beautiful world"}'

# é¢„æœŸ:
# - éŸ³é¢‘æ—¶é•¿: ~2ç§’ (è€Œé 13ç§’)
# - éŸ³é¢‘è´¨é‡: æ¸…æ™°è‡ªç„¶
```

---

## 6. é¢„æœŸæ”¹è¿›æ•ˆæœ

### Before (å½“å‰):
```
è¾“å…¥: "Hello beautiful world"
éŸ³ç´ : "hello beautiful world" âŒ (é”™è¯¯)
éŸ³é¢‘: 13.2ç§’ (è¿‡é•¿) âŒ
è´¨é‡: ä½ (å™ªéŸ³/ä¸è‡ªç„¶) âŒ
```

### After (espeak é›†æˆ):
```
è¾“å…¥: "Hello beautiful world"
éŸ³ç´ : "hÉ™lËˆoÊŠ bjËˆuËtÉªfÉ™l wËˆÉœËld" âœ… (æ­£ç¡®)
éŸ³é¢‘: ~2ç§’ (æ­£å¸¸) âœ…
è´¨é‡: é«˜ (æ¸…æ™°è‡ªç„¶) âœ…
```

---

## 7. ç»“è®º

### å½“å‰çŠ¶æ€

| æ–¹é¢ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| **æ¶æ„è®¾è®¡** | â­â­â­â­â­ | ONNX é›†æˆã€ç¼“å­˜ç³»ç»Ÿå®Œç¾ |
| **ONNX æ¨ç†** | â­â­â­â­â­ | ort 2.0-rc è°ƒç”¨æ­£ç¡® |
| **éŸ³ç´ åŒ–** | â­â˜†â˜†â˜†â˜† | **ä¸¥é‡ç¼ºé™·** - æ— çœŸå®éŸ³ç´  |
| **æ•´ä½“å¯ç”¨æ€§** | â­â­â˜†â˜†â˜† | éœ€ä¿®å¤éŸ³ç´ åŒ–æ‰èƒ½æŠ•äº§ |

### æœ€ä½³å®è·µå¯¹é½åº¦

```
æˆ‘ä»¬çš„å®ç°:   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 80%
Kokoros æ ‡å‡†: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%

å·®è·: espeak-ng éŸ³ç´ åŒ– (20%)
```

### å»ºè®®

1. **ç«‹å³è¡ŒåŠ¨**: é›†æˆ espeak-ng (æ–¹æ¡ˆ A - ç³»ç»Ÿè°ƒç”¨)
2. **çŸ­æœŸä¼˜åŒ–**: æ·»åŠ æ–‡æœ¬è§„èŒƒåŒ–
3. **ä¸­æœŸç›®æ ‡**: æ€§èƒ½ä¼˜åŒ– + æ¨¡å‹é‡åŒ–
4. **é•¿æœŸæ„¿æ™¯**: åŠŸèƒ½å®Œå–„ + å¤šè¯­è¨€

**æ—¶é—´ä¼°ç®—**:
- ä¿®å¤éŸ³ç´ åŒ–: 2-4 å°æ—¶ â°
- è¾¾åˆ°ç”Ÿäº§è´¨é‡: 1-2 å¤© ğŸ“…
- å®Œæ•´åŠŸèƒ½: 1-2 å‘¨ ğŸ“†

---

**ç»´æŠ¤è€…**: Jason
**å‚è€ƒ**: https://github.com/lucasjinreal/Kokoros
